;ps-dphil-statistics.lisp(defun poisson-probability-table (mu max-r)  (let (prev-value        (table nil))    (dotimes (r (1+ max-r) (reverse table))      (setf table (cons (list r                               (setf prev-value                                     (if (zerop r)                                      (exp (- mu))                                      (* prev-value                                         (/ mu r)))))                        table)))))(defun pprint-poisson-table (poisson-probability-table)  (format t "~%      r       p")  (dolist (r-prob-pair poisson-probability-table)    (format t             "~%~7d  ~,4f"            (first r-prob-pair)            (second r-prob-pair))))(defun poisson-prob-range (pt                            &key                            (max-r (1- (list-length pt)))                           (min-r 0))  (do* ((p 0)        (r min-r (1+ r)))       ((= r (1+ max-r))        p)    (setf p (+ p               (second (elt pt r))))))(defun binomial-coefficient (n r)  (let ((b 1))    (dotimes (k r b)      (setf b (* b (/ (- n k) (- r k)))))))(defun pr-r-hits-in-n-trials (n r p)  (* (binomial-coefficient n r)     (expt p r)     (expt (- 1 p) (- n r))))(defun pr-r-or-fewer-hits-in-n-trials (n r p)  (let* ((pr 0))    (dotimes (j (1+ r) pr)      (format t "~%~5d  ~a" j (pr-r-hits-in-n-trials n j p))      (setf pr (+ pr (pr-r-hits-in-n-trials n j p))))))(defun pr-r-or-more-hits-in-n-trials (n r p)  (- 1 (pr-r-or-fewer-hits-in-n-trials n (- r 1) p)))(defun probability-of-difference (n r1 r2)  (let* ((p (/ (+ r1 r2) (* 2 n)))         (a (min r1 r2))         (b (max r1 r2))         (pr-a-or-fewer-hits (pr-r-or-fewer-hits-in-n-trials n a p))         (pr-b-or-more-hits (pr-r-or-more-hits-in-n-trials n b p)))    (* pr-a-or-fewer-hits       pr-b-or-more-hits)));Following function prints a four-fold-table and returns values for it(defun compare-algorithms (alg1-file-suffix                           alg2-file-suffix                           &key                           (corpus-file-suffix "opnd-m")                           (file-prefix "")                           (corpus-directory (choose-directory-dialog :button-string corpus-file-suffix))                           (alg1-directory (choose-directory-dialog :button-string alg1-file-suffix))                           (alg2-directory (choose-directory-dialog :button-string alg2-file-suffix)))  (let* ((corpus-file-list (directory (make-pathname :directory (if (listp corpus-directory)                                                                  corpus-directory                                                                  (pathname-directory corpus-directory))                                                     :name (concatenate 'string file-prefix "*")                                                     :type corpus-file-suffix)))         (alg1-file-list (directory (make-pathname :directory (if (listp alg1-directory)                                                                alg1-directory                                                                (pathname-directory alg1-directory))                                                    :name (concatenate 'string file-prefix "*")                                                    :type alg1-file-suffix)))         (alg2-file-list (directory (make-pathname :directory (if (listp alg2-directory)                                                                alg2-directory                                                                (pathname-directory alg2-directory))                                                   :name (concatenate 'string file-prefix "*")                                                   :type alg2-file-suffix))))        ;Check that each directory contains a file for each piece.    (if (not (= (list-length corpus-file-list)                (list-length alg1-file-list)                (list-length alg2-file-list)))      (progn (format t "~%ERROR: Number of files in directories not equal:~%Corpus: ~d~%alg1: ~d~%alg2: ~d"                      (list-length corpus-file-list)                     (list-length alg1-file-list)                     (list-length alg2-file-list))             (abort))            ;Number of files in all directories is equal.      ;Now check that names are the same in each directory.      (let* ((corpus-file-names (mapcar #'pathname-name corpus-file-list))             (alg1-file-names (mapcar #'pathname-name alg1-file-list))             (alg2-file-names (mapcar #'pathname-name alg2-file-list)))        (if (not (and (equalp corpus-file-names alg1-file-names)                      (equalp corpus-file-names alg2-file-names)))          (progn (format t "~%ERROR: Names of files in directories do not correspond.")                 (abort))                    ;Names of files in all directories correspond.                    (let* ((total-number-notes-correct-correct 0)                 (total-number-notes-correct-incorrect 0)                 (total-number-notes-incorrect-correct 0)                 (total-number-notes-incorrect-incorrect 0)                 (total-number-of-notes 0)                 (total-number-pins-correct-correct 0)                 (total-number-pins-correct-incorrect 0)                 (total-number-pins-incorrect-correct 0)                 (total-number-pins-incorrect-incorrect 0)                 (total-number-of-pins 0))            (format t "~%~30a~8@a~8@a~8@a~8@a~8@a~8@a~8@a~8@a~8@a~8@a~10@a~10@a~10@a~10@a~10@a~10@a~10@a~10@a"                    "File name"                    "Notes"                    "Pins"                    "n_cc"                    "n_ci"                    "n_ic"                    "n_ii"                    "p_cc"                    "p_ci"                    "p_ic"                    "p_ii"                    (concatenate 'string alg1-file-suffix " nc")                    (concatenate 'string alg2-file-suffix " nc")                    (concatenate 'string alg1-file-suffix " %nc")                    (concatenate 'string alg2-file-suffix " %nc")                    (concatenate 'string alg1-file-suffix " pc")                    (concatenate 'string alg2-file-suffix " pc")                    (concatenate 'string alg1-file-suffix " %pc")                    (concatenate 'string alg2-file-suffix " %pc"))            (dotimes (i (list-length corpus-file-list))              (let* ((corpus-file (elt corpus-file-list i))                     (alg1-file (elt alg1-file-list i))                     (alg2-file (elt alg2-file-list i))                                          (corpus-dataset (sort-by-onset (read-dataset corpus-file)))                     (alg1-dataset (sort-by-onset (read-dataset alg1-file)))                     (alg2-dataset (sort-by-onset (read-dataset alg2-file)))                                          (number-of-notes (list-length corpus-dataset))                     (number-of-pins (1- number-of-notes))                                          (corpus-pitch-list (mapcar #'pn2p (mapcar #'second corpus-dataset)))                     (alg1-pitch-list (mapcar #'pn2p (mapcar #'second alg1-dataset)))                     (alg2-pitch-list (mapcar #'pn2p (mapcar #'second alg2-dataset)))                                          (corpus-pi-list (mapcar #'p2pi                                              (butlast corpus-pitch-list)                                             (cdr corpus-pitch-list)))                     (alg1-pi-list (mapcar #'p2pi                                             (butlast alg1-pitch-list)                                            (cdr alg1-pitch-list)))                     (alg2-pi-list (mapcar #'p2pi                                            (butlast alg2-pitch-list)                                           (cdr alg2-pitch-list)))                                          (alg1-note-result-list (mapcar #'(lambda (p1 p2)                                                         (if (equalp p1 p2)                                                           1 0))                                                     alg1-pitch-list                                                     corpus-pitch-list))                     (alg2-note-result-list (mapcar #'(lambda (p1 p2)                                                        (if (equalp p1 p2)                                                          1 0))                                                    alg2-pitch-list                                                    corpus-pitch-list))                                          (alg1-number-notes-correct (count 1 alg1-note-result-list))                     (alg2-number-notes-correct (count 1 alg2-note-result-list))                                          (alg1-proportion-notes-correct (/ alg1-number-notes-correct number-of-notes))                     (alg2-proportion-notes-correct (/ alg2-number-notes-correct number-of-notes))                                          (alg1-pin-result-list (mapcar #'(lambda (p1 p2)                                                        (if (equalp p1 p2)                                                          1 0))                                                    alg1-pi-list                                                    corpus-pi-list))                     (alg2-pin-result-list (mapcar #'(lambda (p1 p2)                                                       (if (equalp p1 p2)                                                         1 0))                                                   alg2-pi-list                                                   corpus-pi-list))                                          (alg1-number-pins-correct (count 1 alg1-pin-result-list))                     (alg2-number-pins-correct (count 1 alg2-pin-result-list))                                          (alg1-proportion-pins-correct (/ alg1-number-pins-correct number-of-pins))                     (alg2-proportion-pins-correct (/ alg2-number-pins-correct number-of-pins))                                          (notes-correct-correct-list (mapcar #'(lambda (alg1-note-result                                                                    alg2-note-result)                                                             (if (and (= 1 alg1-note-result)                                                                      (= 1 alg2-note-result))                                                               1 0))                                                         alg1-note-result-list                                                         alg2-note-result-list))                     (notes-correct-incorrect-list (mapcar #'(lambda (alg1-note-result                                                                      alg2-note-result)                                                               (if (and (= 1 alg1-note-result)                                                                        (= 0 alg2-note-result))                                                                 1 0))                                                           alg1-note-result-list                                                           alg2-note-result-list))                     (notes-incorrect-correct-list (mapcar #'(lambda (alg1-note-result                                                                      alg2-note-result)                                                               (if (and (= 0 alg1-note-result)                                                                        (= 1 alg2-note-result))                                                                 1 0))                                                           alg1-note-result-list                                                           alg2-note-result-list))                     (notes-incorrect-incorrect-list (mapcar #'(lambda (alg1-note-result                                                                        alg2-note-result)                                                                 (if (and (= 0 alg1-note-result)                                                                          (= 0 alg2-note-result))                                                                   1 0))                                                             alg1-note-result-list                                                             alg2-note-result-list))                                                               (pins-correct-correct-list (mapcar #'(lambda (alg1-pin-result                                                                    alg2-pin-result)                                                             (if (and (= 1 alg1-pin-result)                                                                      (= 1 alg2-pin-result))                                                               1 0))                                                         alg1-pin-result-list                                                         alg2-pin-result-list))                     (pins-correct-incorrect-list (mapcar #'(lambda (alg1-pin-result                                                                      alg2-pin-result)                                                               (if (and (= 1 alg1-pin-result)                                                                        (= 0 alg2-pin-result))                                                                 1 0))                                                           alg1-pin-result-list                                                           alg2-pin-result-list))                     (pins-incorrect-correct-list (mapcar #'(lambda (alg1-pin-result                                                                      alg2-pin-result)                                                               (if (and (= 0 alg1-pin-result)                                                                        (= 1 alg2-pin-result))                                                                 1 0))                                                           alg1-pin-result-list                                                           alg2-pin-result-list))                     (pins-incorrect-incorrect-list (mapcar #'(lambda (alg1-pin-result                                                                        alg2-pin-result)                                                                 (if (and (= 0 alg1-pin-result)                                                                          (= 0 alg2-pin-result))                                                                   1 0))                                                             alg1-pin-result-list                                                             alg2-pin-result-list))                                          (number-notes-correct-correct (count 1 notes-correct-correct-list))                     (number-notes-correct-incorrect (count 1 notes-correct-incorrect-list))                     (number-notes-incorrect-correct (count 1 notes-incorrect-correct-list))                     (number-notes-incorrect-incorrect (count 1 notes-incorrect-incorrect-list))                                          (number-pins-correct-correct (count 1 pins-correct-correct-list))                     (number-pins-correct-incorrect (count 1 pins-correct-incorrect-list))                     (number-pins-incorrect-correct (count 1 pins-incorrect-correct-list))                     (number-pins-incorrect-incorrect (count 1 pins-incorrect-incorrect-list)))                (setf total-number-notes-correct-correct (+ total-number-notes-correct-correct number-notes-correct-correct))                (setf total-number-notes-correct-incorrect (+ total-number-notes-correct-incorrect number-notes-correct-incorrect))                (setf total-number-notes-incorrect-correct (+ total-number-notes-incorrect-correct number-notes-incorrect-correct))                (setf total-number-notes-incorrect-incorrect (+ total-number-notes-incorrect-incorrect number-notes-incorrect-incorrect))                (setf total-number-of-notes (+ total-number-of-notes number-of-notes))                (setf total-number-pins-correct-correct (+ total-number-pins-correct-correct number-pins-correct-correct))                (setf total-number-pins-correct-incorrect (+ total-number-pins-correct-incorrect number-pins-correct-incorrect))                (setf total-number-pins-incorrect-correct (+ total-number-pins-incorrect-correct number-pins-incorrect-correct))                (setf total-number-pins-incorrect-incorrect (+ total-number-pins-incorrect-incorrect number-pins-incorrect-incorrect))                (setf total-number-of-pins (+ total-number-of-pins number-of-pins))                                ;Output data for this piece                (format t "~%~30a~8d~8d~8d~8d~8d~8d~8d~8d~8d~8d~10d~10d~10,2f~10,2f~10d~10d~10,2f~10,2f"                        (elt corpus-file-names i)                        number-of-notes                        number-of-pins                        number-notes-correct-correct                        number-notes-correct-incorrect                        number-notes-incorrect-correct                        number-notes-incorrect-incorrect                        number-pins-correct-correct                        number-pins-correct-incorrect                        number-pins-incorrect-correct                        number-pins-incorrect-incorrect                        alg1-number-notes-correct                        alg2-number-notes-correct                        (* 100 alg1-proportion-notes-correct)                        (* 100 alg2-proportion-notes-correct)                        alg1-number-pins-correct                        alg2-number-pins-correct                        (* 100 alg1-proportion-pins-correct)                        (* 100 alg2-proportion-pins-correct))                ))            ;McNemar's test            ;Contingency table for note errors            (format t "~%Results for note errors:")            (mcnemars-test alg1-file-suffix alg2-file-suffix                           total-number-notes-incorrect-incorrect                           total-number-notes-incorrect-correct                           total-number-notes-correct-incorrect                           total-number-notes-correct-correct)                        ;Contingency table for pin errors            (format t "~%Results for pin errors:")            (mcnemars-test alg1-file-suffix alg2-file-suffix                           total-number-pins-incorrect-incorrect                           total-number-pins-incorrect-correct                           total-number-pins-correct-incorrect                           total-number-pins-correct-correct)            )          )))))(defun mcnemars-test (alg1 alg2 n00 n01 n10 n11)  (draw-contingency-table alg1 alg2 n00 n01 n10 n11)  (let* ((chi-squared (/ (expt (1- (abs (- n01 n10))) 2)                         (+ n01 n10)))         (n (+ n00 n01 n10 n11))         (a (/ n10 n))         (d (/ n01 n))         (z (/ (- (abs (- d a)) (/ 1 n))               (sqrt (/ (+ a d)                        n))))         (z-sig (z-sig z))         (chi-squared-sig (chi-squared-sig chi-squared)))    (format t "~%chi-squared (1 d.f.) = ~,6f (p<=~,4f)" chi-squared chi-squared-sig)    (format t "~%z = ~,6f (p<=~,4f)" z z-sig)    (format t (concatenate 'string                            "~%~a"                           (string #\Tab)                           "~a"                           (string #\Tab)                           "~d"                           (string #\Tab)                           "~d"                           (string #\Tab)                           "~d"                           (string #\Tab)                           "~d"                           (string #\Tab)                           "~,6f"                           (string #\Tab)                           "~,4f"                           (string #\Tab)                           "~,6f"                           (string #\Tab)                           "~,4f"                           (string #\Tab)                           )            alg1 alg2 n00 n01 n10 n11            chi-squared chi-squared-sig            z z-sig            )))(defun chi-squared-sig (chi-squared)  (let* ((chi-squared-list '(0 .45493 1.3233 2.7055 2.87437 3.0649 3.28303 3.53738 3.68208 3.841459 4.2179 4.70927                              5.02389 5.4119 6.63490 7.14915 7.87944 9.1406 10.8275 11.36105 12.11568 13.41215 15.1367))         ;values obtained from www.fon.hum.uva.nl         (sig-list '(1 .5 .25 .1 .09 .08 .07 .06 .055 0.05 .04 .03 .025 .02 .01 .0075 .005 .0025 .001 .00075 .0005 .00025  .0001)))    (do* ((i 0 (1+ i)))         ((or (= i (list-length chi-squared-list))              (< chi-squared (elt chi-squared-list i)))          (elt sig-list (1- i))))))(defun z-sig (z)  (let* ((z-list '(0 .67449 1.15035 1.644853 1.695397 1.750686 1.81191 1.880793 1.918876 1.959964 2.053749 2.170091 2.241403 2.326348                   2.575829 2.673787 2.807034 3.023341 3.290527 3.370617 3.480757 3.662259 3.89059))         (sig-list '(1 .5 .25 .1 .09 .08 .07 .06 .055 0.05 .04 .03 .025 .02 .01 .0075 .005 .0025 .001 .00075 .0005 .00025  .0001)))    (do* ((i 0 (1+ i)))         ((or (= i (list-length z-list))              (< (abs z) (elt z-list i)))          (elt sig-list (1- i))))))(defun t-sig (t-stat df)  (let* ((t-array '((df     .25     .20     .15     .10     .05     .025     .01    .005   .0005)                    ( 1   1.000   1.376   1.963   3.078   6.314   12.706  31.821  63.657  636.62)                    ( 2   0.816   1.061   1.386   1.886   2.920    4.303  6.965    9.925  31.599)                    ( 3   0.765   0.978   1.250   1.638   2.353    3.182  4.541    5.841  12.924)                    ( 4   0.741   0.941   1.190   1.533   2.132    2.776  3.747    4.604  8.610)                    ( 5   0.727   0.920   1.156   1.476   2.015    2.571  3.365    4.032  6.869)                    ( 6   0.718   0.906   1.134   1.440   1.943    2.447  3.143    3.707  5.959)                    ( 7   0.711   0.896   1.119   1.415   1.895    2.365  2.998    3.499  5.408)                    ( 8   0.706   0.889   1.108   1.397   1.860    2.306  2.896    3.355  5.041)                    ( 9   0.703   0.883   1.100   1.383   1.833    2.262  2.821    3.250  4.781)                    ( 10    0.700   0.879   1.093   1.372   1.812    2.228  2.764    3.169  4.587)                    ( 11    0.697   0.876   1.088   1.363   1.796    2.201  2.718    3.106  4.437)                    ( 12    0.695   0.873   1.083   1.356   1.782    2.179  2.681    3.055  4.318)                    ( 13    0.694   0.870   1.079   1.350   1.771    2.160  2.650    3.012  4.221)                    ( 14    0.692   0.868   1.076   1.345   1.761    2.145  2.624    2.977  4.140)                    ( 15    0.691   0.866   1.074   1.341   1.753    2.131  2.602    2.947  4.073)                    ( 16    0.690   0.865   1.071   1.337   1.746    2.120  2.583    2.921  4.015)                    ( 17    0.689   0.863   1.069   1.333   1.740    2.110  2.567    2.898  3.965)                    ( 18    0.688   0.862   1.067   1.330   1.734    2.101  2.552    2.878  3.922)                    ( 19    0.688   0.861   1.066   1.328   1.729    2.093  2.539    2.861  3.883)                    ( 20    0.687   0.860   1.064   1.325   1.725    2.086  2.528    2.845  3.850)                    ( 21    0.686   0.859   1.063   1.323   1.721    2.080  2.518    2.831  3.819)                    ( 22    0.686   0.858   1.061   1.321   1.717    2.074  2.508    2.819  3.792)                    ( 23    0.685   0.858   1.060   1.319   1.714    2.069  2.500    2.807  3.768)                    ( 24    0.685   0.857   1.059   1.318   1.711    2.064  2.492    2.797  3.745)                    ( 25    0.684   0.856   1.058   1.316   1.708    2.060  2.485    2.787  3.725)                    ( 26    0.684   0.856   1.058   1.315   1.706    2.056  2.479    2.779  3.707)                    ( 27    0.684   0.855   1.057   1.314   1.703    2.052  2.473    2.771  3.690 )                    ( 28    0.683   0.855   1.056   1.313   1.701    2.048  2.467    2.763  3.674)                    ( 29    0.683   0.854   1.055   1.311   1.699    2.045  2.462    2.756  3.659)                    ( 30    0.683   0.854   1.055   1.310   1.697    2.042  2.457    2.750  3.646)                    ( 40    0.681   0.851   1.050   1.303   1.684    2.021  2.423    2.704  3.551)                    ( 50    0.679   0.849   1.047   1.299   1.676    2.009  2.403    2.678  3.496)                    ( 100   0.677   0.845   1.042   1.290   1.660    1.984  2.364    2.626  3.390)                    ( Inf   0.674   0.842   1.036   1.282   1.645    1.960  2.326    2.576  3.291)))         (row (cond ((<= df 30)                     (elt t-array df))                    ((<= 31 df 35)                     (elt t-array 30))                    ((<= 36 df 45)                     (elt t-array 31))                    ((<= 46 df 75)                     (elt t-array 32))                    ((<= 76 df 200)                     (elt t-array 33))                    (t                      (elt t-array 34)))))    (do* ((c 1 (1+ c))          (p 1))         ((or (= c 10)              (< (abs t-stat) (elt row c)))          p)      (setf p (elt (elt t-array 0) c)))))(defun draw-contingency-table (alg1 alg2 n00 n01 n10 n11)  (format t "~%~63@a" alg2)  (format t "~%~20@a~20@a|~20@a ~20@a|~20@a|" "" "" "Incorrect      " "Correct      "  "Total        ")  (format t "~%")(dotimes (i 103) (format t "-"))  (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"           alg1          "Incorrect"          n00          n01          (+ n00             n01))  (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"          ""          "Correct"          n10          n11          (+ n10             n11))  (format t "~%")(dotimes (i 103) (format t "-"))  (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"          ""          "Total"          (+ n00             n10)          (+ n01             n11)          (+ (+ n00                n10)             (+ n01                n11))))#|Unused output routines for compare-algorithms            ;Now we print out a fourfold table a la Fleiss (1973), p.14                                                (format t "~%~%Chi-squared for this table (Fleiss, 1973, p.14) = ~,4f"                     (chi-squared-fleiss-1973-p-14 total-number-notes-correct-correct                                                  total-number-notes-correct-incorrect                                                  total-number-notes-incorrect-correct                                                  total-number-notes-incorrect-incorrect))                        (format t "~%Chi-squared for this table (Fleiss, 1973, p.17) = ~,4f"                     (chi-squared-fleiss-1973-p-17 total-number-notes-correct-correct                                                  total-number-notes-correct-incorrect                                                  total-number-notes-incorrect-correct                                                  total-number-notes-incorrect-incorrect))                        (format t "~%z for difference between proportions correct (Fleiss, 1973, p.18) = ~,4f (z^2 = ~,4f)~%~%"                     (setf z (z-fleiss-1973-p-18 total-number-notes-correct-correct                                                total-number-notes-correct-incorrect                                                total-number-notes-incorrect-correct                                                total-number-notes-incorrect-incorrect))                    (* z z))                        (progn (format t "~%~%Fourfold table in the style of Fleiss (1973, p.14) showing pin errors~%======================================================================~%")                   (format t "~%~63@a" alg2-file-suffix)                   (format t "~%~20@a~20@a|~20@a ~20@a|~20@a|" "" "" "Correct      " "Incorrect      " "Total        ")                   (format t "~%")(dotimes (i 103) (format t "-"))                   (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"                            alg1-file-suffix                           "Correct"                           total-number-pins-correct-correct                           total-number-pins-correct-incorrect                           (+ total-number-pins-correct-correct                              total-number-pins-correct-incorrect))                   (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"                           ""                           "Incorrect"                           total-number-pins-incorrect-correct                           total-number-pins-incorrect-incorrect                           (+ total-number-pins-incorrect-correct                              total-number-pins-incorrect-incorrect))                   (format t "~%")(dotimes (i 103) (format t "-"))                   (format t "~%~20@a~20@a|~20@a|~20@a|~20@a|"                           ""                           "Total"                           (+ total-number-pins-correct-correct                              total-number-pins-incorrect-correct)                           (+ total-number-pins-correct-incorrect                              total-number-pins-incorrect-incorrect)                           (+ (+ total-number-pins-correct-correct                                 total-number-pins-incorrect-correct)                              (+ total-number-pins-correct-incorrect                                 total-number-pins-incorrect-incorrect))))                        (format t "~%~%Chi-squared for this table (Fleiss, 1973, p.14) = ~,4f"                     (chi-squared-fleiss-1973-p-14 total-number-pins-correct-correct                                                  total-number-pins-correct-incorrect                                                  total-number-pins-incorrect-correct                                                  total-number-pins-incorrect-incorrect))                        (format t "~%Chi-squared for this table (Fleiss, 1973, p.17) = ~,4f"                     (chi-squared-fleiss-1973-p-17 total-number-pins-correct-correct                                                  total-number-pins-correct-incorrect                                                  total-number-pins-incorrect-correct                                                  total-number-pins-incorrect-incorrect))                        (format t "~%HAVE TO CHANGE DEFINITION OF FOLLOWING BECAUSE USES A DIFFERENT FOURFOLD TABLE")            (format t "~%z for difference between proportions correct (Fleiss, 1973, p.18) = ~,4f (z^2 = ~,4f)~%~%"                     (setf z (z-fleiss-1973-p-18 total-number-pins-correct-correct                                                total-number-pins-correct-incorrect                                                total-number-pins-incorrect-correct                                                total-number-pins-incorrect-incorrect))                    (* z z))|#          ;Following returs chi-squared value in accordance with formula in Fleiss (1973, p.14)(defun chi-squared-fleiss-1973-p-14 (n-cc n-ci n-ic n-ii)  (let* ((n-__ (+ n-cc n-ci n-ic n-ii))         (n-c_ (+ n-cc n-ci))         (n-_c (+ n-cc n-ic))         (n-i_ (+ n-ic n-ii))         (n-_i (+ n-ci n-ii)))    (* 1.0 (/ (* n-__ (expt (- (abs (- (* n-cc n-ii)                                       (* n-ci n-ic)))                               (/ n-__ 2))                             2))              (* n-c_ n-i_ n-_c n-_i)))))(defun chi-squared-fleiss-1973-p-17 (n-cc n-ci n-ic n-ii)  (let* ((n-__ (+ n-cc n-ci n-ic n-ii))         (p-cc (/ n-cc n-__))         (p-ci (/ n-ci n-__))         (p-ic (/ n-ic n-__))         (p-ii (/ n-ii n-__))         (n-c_ (+ n-cc n-ci))         (n-_c (+ n-cc n-ic))         (n-i_ (+ n-ic n-ii))         (n-_i (+ n-ci n-ii))         (p-c_ (/ n-c_ n-__))         (p-_c (/ n-_c n-__))         (p-i_ (/ n-i_ n-__))         (p-_i (/ n-_i n-__))         (p-cc-term (/ (expt (- (abs (- p-cc (* p-c_ p-_c)))                                (/ 1 (* 2 n-__)))                             2)                       (* p-c_ p-_c)))         (p-ci-term (/ (expt (- (abs (- p-ci (* p-c_ p-_i)))                                (/ 1 (* 2 n-__)))                             2)                       (* p-c_ p-_i)))         (p-ic-term (/ (expt (- (abs (- p-ic (* p-i_ p-_c)))                                (/ 1 (* 2 n-__)))                             2)                       (* p-i_ p-_c)))         (p-ii-term (/ (expt (- (abs (- p-ii (* p-i_ p-_i)))                                (/ 1 (* 2 n-__)))                             2)                       (* p-i_ p-_i))))    (* 1.0 n-__ (+ p-cc-term p-ci-term p-ic-term p-ii-term))))(defun z-fleiss-1973-p-18 (n-cc n-ci n-ic n-ii)  (let* ((a (+ n-cc n-ci))         (b (+ n-cc n-ic))         (n (+ n-cc n-ci n-ic n-ii))         (p2 (/ b n))         (p1 (/ a n))         (n-1_ n)         (n-2_ n)         (p-bar (/ (+ a b) (* 2 n)))         (q-bar (- 1 p-bar)))    (* 1.0       (/ (- (abs (- p2 p1))             (* 1/2 (+ (/ 1 n-1_)                       (/ 1 n-2_))))          (sqrt (* p-bar                   q-bar                   (+ (/ 1 n-1_)                      (/ 1 n-2_))))))))#|Running compare-algorithms on Cambouropoulos's algorithms:(let* ((parent-directory (pathname-directory (choose-directory-dialog :button-string "Parent")))       (algorithms (mapcar #'string-downcase '(C1D                                               C1E                                               C3B                                               C3C                                               C3D                                               C3E                                               C3F                                               C3G                                               C3H                                               C3I                                               C3J                                               C3K                                               C3L                                               C3M                                               C3N                                               C3O                                               C3P                                               C3R                                               C3S                                               C3T                                               C3U)))       (alg1-directory (append parent-directory (list "c3a")))       (corpus-directory (append parent-directory (list "opnd-m"))))  (dolist (alg2 algorithms)    (compare-algorithms "c3a" alg2                        :corpus-directory corpus-directory                        :alg1-directory alg1-directory                        :alg2-directory (append parent-directory (list alg2)))))(string parent-directory)|##|Following function takes an OPNDV file as computed by a pitch spellingalgorithm, together with the OPNDV file from the corpus and it generatesa CBL file. A CBL file is just a list of 1s and 0s in which a 1 indicates acorrectly spelt note and a 0 indicates an incorrectly spelt note.A CBLI file is the same as a  CBL file except that each element indicates thecorrectness or incorrectness of an interval between two consecutive notes.The notes are sorted using sort-by-onset.|#(defun opnd2cbl (&optional                 (alg-file (choose-file-dialog :button-string "Alg File"))                 (corpus-suffix "opnd-m")                 (corpus-directory (choose-directory-dialog :button-string corpus-suffix))                 (output-directory (choose-directory-dialog :button-string "OUTPUT")))  (let* ((alg-dataset (sort-by-onset (read-dataset alg-file)))         (corpus-dataset (sort-by-onset (read-dataset                                          (make-pathname :directory (pathname-directory corpus-directory)                                                        :name (pathname-name alg-file)                                                        :type corpus-suffix))))         (alg-pitch-list (mapcar #'pn2p (mapcar #'second alg-dataset)))         (corpus-pitch-list (mapcar #'pn2p (mapcar #'second corpus-dataset)))         (number-of-notes (list-length corpus-dataset)))    (if (and (= (list-length alg-dataset)                (list-length corpus-dataset))             (equalp (mapcar #'(lambda (datapoint)                                 (list (first datapoint)                                       (third datapoint)                                       (fourth datapoint)))                             alg-dataset)                     (mapcar #'(lambda (datapoint)                                 (list (first datapoint)                                       (third datapoint)                                       (fourth datapoint)))                             corpus-dataset))             (equalp (mapcar #'first alg-pitch-list)                     (mapcar #'first corpus-pitch-list)))      (let* ((alg-morphetic-pitch-list (mapcar #'second alg-pitch-list))             (corpus-morphetic-pitch-list (mapcar #'second corpus-pitch-list))             (cbl (mapcar #'(lambda (pm-alg pm-corpus)                              (if (= pm-alg pm-corpus)                                1 0))                          alg-morphetic-pitch-list                          corpus-morphetic-pitch-list))             (number-of-errors (count 0 cbl))             (cbl-file-name (make-pathname :directory (pathname-directory output-directory)                                           :name (pathname-name alg-file)                                           :type "cbl")))        (with-open-file (cbl-stream                         cbl-file-name                         :direction :output                         :if-exists :rename-and-delete)          (pprint cbl cbl-stream))        (format t "~%File: ~a. Number of notes = ~d. Note errors = ~d. % notes correct = ~,2f%"                (pathname-name alg-file)                number-of-notes                number-of-errors                (* 100.0 (/ (- number-of-notes number-of-errors) number-of-notes))))      (progn (format t "~%ERROR: Alg file and corpus file incompatible.")))))(defun batch-opnd2cbl (alg-suffix                       &optional                        (alg-directory (choose-directory-dialog :button-string alg-suffix))                       (corpus-suffix "opnd-m")                       (corpus-directory (choose-directory-dialog :button-string corpus-suffix))                       (output-directory (choose-directory-dialog :button-string "Output"))                       )  (let* ((alg-file-list (directory (make-pathname :directory (pathname-directory alg-directory)                                                  :name :wild                                                  :type alg-suffix))))    (dolist (alg-file alg-file-list)      (opnd2cbl alg-file                corpus-suffix                corpus-directory                output-directory))))#|Following function investigates significance of difference between results of twoalgorithms on the same corpus.|#(defun comp2algs1corpus (alg1                          alg2                         &key                         (alg1-cbl-directory (choose-directory-dialog :button-string alg1))                         (alg2-cbl-directory (choose-directory-dialog :button-string alg2))                         (file-prefix "")                         (output-directory (choose-directory-dialog :button-string "Output")))  (let* ((output-file (make-pathname :directory (pathname-directory output-directory)                                     :name (concatenate 'string                                                         alg1 "-" alg2                                                        (if (string/= file-prefix "")                                                          "-" "")                                                        file-prefix)                                     :type "2a1c"))         (alg1-cbl-file-list (directory (make-pathname :directory (if (listp alg1-cbl-directory)                                                                    alg1-cbl-directory                                                                    (pathname-directory alg1-cbl-directory))                                                       :name (concatenate 'string file-prefix "*")                                                       :type "cbl")))         (alg2-cbl-file-list (directory (make-pathname :directory (if (listp alg2-cbl-directory)                                                                    alg2-cbl-directory                                                                    (pathname-directory alg2-cbl-directory))                                                       :name (concatenate 'string file-prefix "*")                                                       :type "cbl")))         (alg1-cbl-list (mapcar #'read-dataset alg1-cbl-file-list))         (alg2-cbl-list (mapcar #'read-dataset alg2-cbl-file-list))         (alg1-list-of-sizes (mapcar #'list-length alg1-cbl-list))         (alg2-list-of-sizes (mapcar #'list-length alg2-cbl-list))         (number-of-movements (list-length alg1-cbl-list)))    (if (not (equalp alg1-list-of-sizes                     alg2-list-of-sizes))      (progn (format t "~%ERROR: Directories do not contain compatible file sets.")             (abort))            (let* ((alg1-list-of-movement-proportions (mapcar #'(lambda (cbl-for-movement)                                                            (/ (count 1 cbl-for-movement)                                                               (list-length cbl-for-movement)))                                                        alg1-cbl-list))                          (alg2-list-of-movement-proportions (mapcar #'(lambda (cbl-for-movement)                                                            (/ (count 1 cbl-for-movement)                                                               (list-length cbl-for-movement)))                                                        alg2-cbl-list))             (alg1-total-cbl (apply #'append alg1-cbl-list))             (alg2-total-cbl (apply #'append alg2-cbl-list))             (alg1-alg2-total-cbl-comparison (mapcar #'(lambda (a1 a2)                                                         (cond ((and (= 1 a1)                                                                     (= 1 a2))                                                                 'a)                                                               ((and (= 0 a1)                                                                     (= 1 a2))                                                                'b)                                                               ((and (= 1 a1)                                                                     (= 0 a2))                                                                'c)                                                               ((and (= 0 a1)                                                                     (= 0 a2))                                                                'd)))                                                     alg1-total-cbl                                                     alg2-total-cbl))             (a (count 'a alg1-alg2-total-cbl-comparison))             (b (count 'b alg1-alg2-total-cbl-comparison))             (c (count 'c alg1-alg2-total-cbl-comparison))             (d (count 'd alg1-alg2-total-cbl-comparison))             (total-number-of-notes (apply #'+ alg1-list-of-sizes))             (number-of-pseudo-movements (do* ((absinc 0 (1+ absinc))                                               (inc (if (oddp absinc) absinc (- absinc))                                                    (if (oddp absinc) absinc (- absinc)))                                               (nopm number-of-movements (+ inc nopm)))                                              ((or (<= nopm 0)                                                   (= (floor total-number-of-notes                                                             nopm)                                                      (/ total-number-of-notes nopm))                                                   )                                               (if (<= nopm 0)                                                 (progn (format t "~%ERROR: Cannot find number of pseudo-movements.")                                                        (abort))                                                 nopm))))             (pseudo-movement-size (/ total-number-of-notes                                      number-of-pseudo-movements))             (alg1-total-number-of-correct-notes (count 1 alg1-total-cbl))             (alg2-total-number-of-correct-notes (count 1 alg2-total-cbl))             (p1 (* 1.0 (/ alg1-total-number-of-correct-notes                           total-number-of-notes)))             (p2 (* 1.0 (/ alg2-total-number-of-correct-notes                           total-number-of-notes)))                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;             ;Pickering's suggestion of matched sample t-test.             ;Howell1982, p.126             ;Kanji1993, p.30                          (list-of-differences (mapcar #'-                                          alg2-list-of-movement-proportions                                          alg1-list-of-movement-proportions))             (mean-difference (mean list-of-differences))             (sd-of-differences (standard-deviation list-of-differences))             (matched-sample-t-over-movements (if (/= 0 sd-of-differences)                                                (/ mean-difference                                                   (/ sd-of-differences                                                      (sqrt number-of-movements)))                                                0))                          ;;;;;;;;;;;;;;;;;;;;;;;;;;             ;95% confidence intervals                          ;Standard error in proportion as given by             ;Everitt (1992,13), Hoel (1964,110) and McNemar (1969,51-52).                          (p1se (sqrt (/ (* p1 (- 1 p1))                            total-number-of-notes)))             (p2se (sqrt (/ (* p2 (- 1 p2))                            total-number-of-notes)))             (pi1min (- p1 (* 1.96 p1se)))             (pi1max (+ p1 (* 1.96 p1se)))             (pi2min (- p2 (* 1.96 p2se)))             (pi2max (+ p2 (* 1.96 p2se)))                          ;;;;;;;;;;;;;;;             ;McNemar's test             ;Everitt (1992,19), McNemar (1969,54--58), Fleiss (1973,74--77)             ;a = number of notes spelt correctly by both algorithms             ;b = number of notes spelt incorrectly by A1 but correctly by A2             ;c = number of notes spelt correctly by A1 but incorrectly by A2             ;d = number of notes spelt incorrectly by both algorithms                          (mcnemar-z (if (/= 0 (+ b c))                          (* 1.0                             (/ (- (abs (- b c)) 1)                                (sqrt (+ b c))))                          0))             (mcnemar-chi-square (if (/= 0 (+ b c))                                   (* 1.0                                      (/ (expt (- (abs (- b c)) 1) 2)                                         (+ b c)))                                   0))             (mcnemar-relative-difference (if (/= 0 (+ b d))                                            (* 1.0                                               (/ (- b c)                                                  (+ b d)))                                            0))             (mcnemar-se-of-rel-diff (if (/= 0 (+ b d))                                       (* 1.0                                          (/ (sqrt (- (* (+ b c d)                                                         (+ (* b c) (* b d) (* c d)))                                                      (* b c d)))                                             (expt (+ b d) 2)))                                       0))                          ;;;;;;;;;;;;;;             ;Z-test for correlated proportions             ;see Kanji (1993,48)             (sigma (sqrt (/ (- (+ b c)                                (/ (expt (- b c) 2)                                   total-number-of-notes))                             (* total-number-of-notes                                (- total-number-of-notes 1)))))                          (z-for-correlated-proportions              (if (/= 0 sigma)                (/ (- b c)                   (* total-number-of-notes                      sigma))                0))                                       ;;;;;;;;;;;;;;;;;;;;;;             ;Matched sample t-test over non-shuffled pseudo-movements of equal size             (alg1-list-of-pseudo-movement-proportions (let* ((l nil))                                                         (dotimes (i number-of-pseudo-movements l)                                                           (setf l                                                                 (cons (/ (count 1 alg1-total-cbl                                                                                 :start (* i pseudo-movement-size)                                                                                 :end (* (1+ i) pseudo-movement-size))                                                                          pseudo-movement-size)                                                                       l)))))             (alg2-list-of-pseudo-movement-proportions (let* ((l nil))                                                         (dotimes (i number-of-pseudo-movements l)                                                           (setf l                                                                 (cons (/ (count 1 alg2-total-cbl                                                                                 :start (* i pseudo-movement-size)                                                                                 :end (* (1+ i) pseudo-movement-size))                                                                          pseudo-movement-size)                                                                       l)))))             (list-of-pseudo-movement-differences (mapcar #'-                                                          alg2-list-of-pseudo-movement-proportions                                                          alg1-list-of-pseudo-movement-proportions))             (mean-non-shuffled-pseudo-movement-difference (mean list-of-pseudo-movement-differences))             (sd-of-non-shuffled-pseudo-movement-differences (standard-deviation list-of-pseudo-movement-differences))             (matched-sample-t-over-non-shuffled-pseudo-movements               (if (/= 0 sd-of-non-shuffled-pseudo-movement-differences)                (/ mean-non-shuffled-pseudo-movement-difference                   (/ sd-of-non-shuffled-pseudo-movement-differences                      (sqrt number-of-pseudo-movements)))                0))                          ;;;;;;;;;;;             ;Matched sample t-test over random pseudo-movements.             (list-of-random-pseudo-movement-mean-diffs nil)             (list-of-random-pseudo-movement-sds nil)             (list-of-random-pseudo-movement-ts nil)             (new-alg1-list (copy-list alg1-total-cbl))             (new-alg2-list (copy-list alg2-total-cbl))             (list-of-random-pseudo-movement-mean-diffs-string "")             (list-of-random-pseudo-movement-sds-string "")             (list-of-random-pseudo-movement-ts-string "")             (list-of-random-pseudo-movement-sigs-string "")             )        ;;;;;;;;;;;;;;;;;;;;;;        ;Matched sample t-test over random pseudo-movements        (dotimes (i 5)          (let* ((list-of-pairs (mapcar #'list                                         new-alg1-list                                        new-alg2-list))                 (shuffled-list-of-pairs (sort list-of-pairs                                               #'(lambda (a b)                                                   a b                                                   (zerop (random 2))))))            (setf new-alg1-list (mapcar #'first shuffled-list-of-pairs))            (setf new-alg2-list (mapcar #'second shuffled-list-of-pairs))            (let* ((alg1-list-of-pseudo-movement-proportions (let* ((l nil))                                                               (dotimes (i number-of-pseudo-movements l)                                                                 (setf l                                                                       (cons (/ (count 1 new-alg1-list                                                                                       :start (* i pseudo-movement-size)                                                                                       :end (* (1+ i) pseudo-movement-size))                                                                                pseudo-movement-size)                                                                             l)))))                   (alg2-list-of-pseudo-movement-proportions (let* ((l nil))                                                               (dotimes (i number-of-pseudo-movements l)                                                                 (setf l                                                                       (cons (/ (count 1 new-alg2-list                                                                                       :start (* i pseudo-movement-size)                                                                                       :end (* (1+ i) pseudo-movement-size))                                                                                pseudo-movement-size)                                                                             l)))))                   (list-of-pseudo-movement-differences (mapcar #'-                                                                alg2-list-of-pseudo-movement-proportions                                                                alg1-list-of-pseudo-movement-proportions))                   (mean-pseudo-movement-difference (mean list-of-pseudo-movement-differences))                   (sd-of-pseudo-movement-differences (standard-deviation list-of-pseudo-movement-differences))                   (matched-sample-t-over-pseudo-movements (if (/= 0 sd-of-pseudo-movement-differences)                                                             (/ mean-pseudo-movement-difference                                                                (/ sd-of-pseudo-movement-differences                                                                   (sqrt number-of-pseudo-movements)))                                                             0)))              (setf list-of-random-pseudo-movement-mean-diffs                    (cons mean-pseudo-movement-difference list-of-random-pseudo-movement-mean-diffs)                    list-of-random-pseudo-movement-sds                    (cons sd-of-pseudo-movement-differences list-of-random-pseudo-movement-sds)                    list-of-random-pseudo-movement-ts                    (cons matched-sample-t-over-pseudo-movements list-of-random-pseudo-movement-ts)))))        (setf list-of-random-pseudo-movement-mean-diffs-string              (let* ((s ""))                (dolist (diff list-of-random-pseudo-movement-mean-diffs s)                  (setf s                        (concatenate 'string                                     s                                     (format nil "~,5f " diff)))))              list-of-random-pseudo-movement-sds-string              (let* ((s ""))                (dolist (sd list-of-random-pseudo-movement-sds s)                  (setf s                        (concatenate 'string                                     s                                     (format nil "~,5f " sd)))))              list-of-random-pseudo-movement-ts-string              (let* ((s ""))                (dolist (t-stat list-of-random-pseudo-movement-ts s)                  (setf s                        (concatenate 'string                                     s                                     (format nil "~,5f " t-stat)))))              list-of-random-pseudo-movement-sigs-string              (let* ((s ""))                (dolist (t-stat list-of-random-pseudo-movement-ts s)                  (setf s                        (concatenate 'string                                     s                                     (format nil "~,5f " (t-sig t-stat (1- number-of-pseudo-movements))))))))        (with-open-file (output-stream                         output-file                         :direction :output                         :if-exists :rename-and-delete)          (format output-stream "Comparison between two algorithms when run on same test corpus==============================================================Algorithm 1: ~aAlgorithm 2: ~aFile prefix (determines test corpus): ~aUsing 95% confidence intervals==============================Uses expression  se(p)=sqrt(p(1-p)/N)from Everitt (1992,13), Hoel (1964,110) and McNemar (1969,51-52).p1 = ~,5fp2 = ~,5f95% confidence interval for ~a: ~,5f <= 11 <= ~,5f95% confidence interval for ~a: ~,5f <= 12 <= ~,5fDo confidence intervals overlap? ~aMatched sample t-test over movements====================================As suggested by Alan Pickering. See Howell (1982, p. 126) and Kanji (1993, p.30).Number of movements = ~dMean difference between algorithms wrt proportion of notes spelt correctly over a movement = ~,5fSD of differences = ~,5ft = ~,5fDegrees of freedom = ~dp 2 ~,5fMatched sample t-test over non-shuffled pseudo-movements of equal size======================================================================Number of non-shuffled pseudo-movements = ~dSize of each non-shuffled pseudo-movement = ~dMean difference between proportions of notes spelt correctly over a non-shuffled pseudo-movement = ~,5fSD of non-shuffled pseudo-movement differences = ~,5ft = ~,5fDegrees of freedom = ~dp 2 ~,5fMatched sample t-test over random pseudo-movements==================================================Number of random pseudo-movements = ~dSize of each random pseudo-movement = ~dMean difference between proportions of notes spelt correctly over a random pseudo-movement = ~aSD of random pseudo-movement differences = ~at = ~aDegrees of freedom = ~dp 2 ~aMcNemar's test==============As recommended by Marcus Pearce.See Everitt (1992,19), McNemar (1969,54--58), Fleiss (1973,74--77).a = number of notes spelt correctly by both algorithms = ~db = number of notes spelt incorrectly by ~a but correctly by ~a = ~dc = number of notes spelt correctly by ~a but incorrectly by ~a = ~dd = number of notes spelt incorrectly by both algorithms = ~dN = total number of notes = ~d (should be equal to ~d)z = ~,5f (p 2 ~,5f)chi-square (1 d.f.) = ~,5f (p 2 ~,5f)relative difference (pe) = ~,5f  ~,5f (should be equal to ~,5f)standard error in relative difference (se(pe)) = ~,5f~,5f 2 pe 2 ~,5fZ-test for correlated proportions=================================See Kanji (1993,48).a = number of notes spelt correctly by both algorithms = ~db = number of notes spelt incorrectly by ~a but correctly by ~a = ~dc = number of notes spelt correctly by ~a but incorrectly by ~a = ~dd = number of notes spelt incorrectly by both algorithms = ~dN = total number of notes = ~d (should be equal to ~d)sigma = ~,5fz = ~,5fp 2 ~,5f"                  alg1                  alg2                  file-prefix                                    ;values for confidence intervals                  p1                  p2                  alg1                  pi1min                  pi1max                  alg2                  pi2min                  pi2max                  (if (< p1 p2)                    (if (< pi1max pi2min)                      "No" "Yes")                    (if (< pi2max pi1min)                      "No" "Yes"))                                    ;values for matched t-test over movements                  number-of-movements                  mean-difference                  sd-of-differences                  matched-sample-t-over-movements                  (1- number-of-movements)                  (t-sig matched-sample-t-over-movements (1- number-of-movements))                                    ;values for matched t-test over non-shuffled pseudo-movements                  number-of-pseudo-movements                  pseudo-movement-size                  mean-non-shuffled-pseudo-movement-difference                  sd-of-non-shuffled-pseudo-movement-differences                  matched-sample-t-over-non-shuffled-pseudo-movements                  (1- number-of-pseudo-movements)                  (t-sig matched-sample-t-over-non-shuffled-pseudo-movements                         (1- number-of-pseudo-movements))                                    ;values for matched t-test over random pseudo-movements                  number-of-pseudo-movements                  pseudo-movement-size                  list-of-random-pseudo-movement-mean-diffs-string                  list-of-random-pseudo-movement-sds-string                  list-of-random-pseudo-movement-ts-string                  (1- number-of-pseudo-movements)                  list-of-random-pseudo-movement-sigs-string                                                      ;values for McNemar's test                  a                   alg1 alg2                  b                   alg1 alg2                  c d                  total-number-of-notes                  (+ a b c d)                  mcnemar-z (z-sig mcnemar-z)                  mcnemar-chi-square (chi-squared-sig mcnemar-chi-square)                  mcnemar-relative-difference                  (* 1.96 mcnemar-se-of-rel-diff)                  (* 1.0 (/ (- p2 p1) (- 1 p1)))                  mcnemar-se-of-rel-diff                  (- mcnemar-relative-difference                     (* 1.96 mcnemar-se-of-rel-diff))                  (+ mcnemar-relative-difference                     (* 1.96 mcnemar-se-of-rel-diff))                                    ;values for z-test for correlated proportions                  a                   alg1 alg2                  b                   alg1 alg2                  c d                  total-number-of-notes                  (+ a b c d)                  sigma                  z-for-correlated-proportions                  (z-sig z-for-correlated-proportions))                    (format output-stream "~%~%OUTPUT FOR EXCEL~%================~%")          (dolist (item                   (append (list alg1                                 alg2                                 file-prefix                                                                  ;values for confidence intervals                                 p1                                 p2                                 pi1min                                 pi1max                                 pi2min                                 pi2max                                                                  ;values for matched t-test over movements                                 number-of-movements                                 mean-difference                                 sd-of-differences                                 matched-sample-t-over-movements                                 (1- number-of-movements)                                 (t-sig matched-sample-t-over-movements (1- number-of-movements))                                                                  number-of-pseudo-movements                                 pseudo-movement-size                                                                  ;values for matched t-test over non-shuffled pseudo-movements                                 mean-non-shuffled-pseudo-movement-difference                                 sd-of-non-shuffled-pseudo-movement-differences                                 matched-sample-t-over-non-shuffled-pseudo-movements                                 (1- number-of-pseudo-movements)                                 (t-sig matched-sample-t-over-non-shuffled-pseudo-movements                                        (1- number-of-pseudo-movements))                                                                  ;values for matched t-test over random pseudo-movements                                 )                           list-of-random-pseudo-movement-mean-diffs                           list-of-random-pseudo-movement-sds                           list-of-random-pseudo-movement-ts                           (list (1- number-of-pseudo-movements))                           (mapcar #'(lambda (t-stat)                                       (t-sig t-stat (1- number-of-pseudo-movements)))                                   list-of-random-pseudo-movement-ts)                                                                                 ;values for McNemar's test                           (list a                                  b                                  c d                                 total-number-of-notes                                 mcnemar-z (z-sig mcnemar-z)                                 mcnemar-chi-square (chi-squared-sig mcnemar-chi-square)                                 mcnemar-relative-difference                                 mcnemar-se-of-rel-diff                                                                  ;values for z-test for correlated proportions                                 sigma                                 z-for-correlated-proportions                                 (z-sig z-for-correlated-proportions))))                   (format output-stream (concatenate 'string "~a" (string #\Tab)) item)))))))(defun mean (list-of-values)  (/ (apply #'+ list-of-values)     (list-length list-of-values)))(defun variance (list-of-values)  (let* ((mean (mean list-of-values))         (list-of-square-deviations (mapcar #'(lambda (val)                                                (expt (- val mean) 2))                                            list-of-values))         (sum-of-square-deviations (apply #'+ list-of-square-deviations))         (n (list-length list-of-values)))    (/ sum-of-square-deviations       (- n 1))))(defun standard-deviation (list-of-values)  (sqrt (variance list-of-values)))#|(progn   (setf parent-directory (choose-directory-dialog :button-string "Parent"))  (setf output-directory (choose-directory-dialog :button-string "Output"))  (setf algorithm-pairs (mapcar #'(lambda (alg-pair)                                    (mapcar #'string-downcase                                            alg-pair))                                '((C3A	C1D)                                  (C3A	C1E)                                  (C3A	C3B)                                  (C3A	C3C)                                  (C3A	C3D)                                  (C3A	C3E)                                  (C3A	C3F)                                  (C3A	C3G)                                  (C3A	C3H)                                  (C3A	C3I)                                  (C3A	C3J)                                  (C3A	C3K)                                  (C3A	C3L)                                  (C3A	C3M)                                  (C3A	C3N)                                  (C3A	C3O)                                  (C3A	C3P)                                  (C3A	C3R)                                  (C3A	C3S)                                  (C3A	C3T)                                  (C3A	C3U)                                  (C1D	C1E)                                  (C1D	C3R)                                  (C3E	C3M)                                  (C3E	C3L)                                  (C3B	C3C)                                  (C3F	C3O)                                  (C3F	C3P)                                  (C3K	C3L)                                  (C3L	C3N)                                  (C3M	C3N)                                  (C1E	C3S)                                  (C3R	C3S)))        )  (dolist (alg-pair algorithm-pairs)    (format t "~%~a..." alg-pair)    (comp2algs1corpus (first alg-pair)                      (second alg-pair)                      :alg1-cbl-directory (append (pathname-directory parent-directory)                                                  (list (first alg-pair)))                      :alg2-cbl-directory (append (pathname-directory parent-directory)                                                  (list (second alg-pair)))                      :output-directory output-directory)    (format t "DONE")))|##|Following function gives percentile t bootstrap for a sample of observations usingalgorithm described by Wilcox (2001, 101).|#(defun bootstrap-percentile-t-confidence-interval (sample                                                    &key                                                   (alpha .05)                                                   (b 999))  (let* ((n (list-length sample))         (x-bar (mean sample))         (s (standard-deviation sample))         (list-of-t-stars (let* ((lots nil))                            (dotimes (i b lots)                              (let* ((bootstrap-sample (get-bootstrap-sample sample))                                     (x-bar-star (mean bootstrap-sample))                                     (s-star (standard-deviation bootstrap-sample))                                     (t-star (/ (- x-bar-star x-bar)                                                (/ s-star (sqrt n)))))                                (setf lots (cons t-star lots))))))         (list-of-t-stars (sort list-of-t-stars #'<))         (lower (round (* (/ alpha 2) b)))         (upper (round (* (- 1 (/ alpha 2)) b)))         (s-over-sqrt-n (/ s (sqrt n)))         (t-star-upper (elt list-of-t-stars (1+ upper)))         (t-star-lower (elt list-of-t-stars (1+ lower))))    (list (- x-bar (* t-star-upper s-over-sqrt-n))          (- x-bar (* t-star-lower s-over-sqrt-n)))))(defun get-bootstrap-sample (sample)  (let* ((bs nil)         (n (list-length sample)))    (dotimes (i n bs)      (setf bs (cons (elt sample (random n)) bs)))));;;;;;;;;;;;;;;;;;;;;;;;;Movement class analysis#|(defun mvt-class-statistics (partition                              &optional                             (alg1-dir (choose-directory-dialog :button-string "A1 Dir"))                             (alg2-dir (choose-directory-dialog :button-string "A2 Dir")))  (let* ((alg1-file-list (directory (make-pathname :directory (pathname-directory alg1-dir)                                                   :name :wild                                                   :type "cbl")))         (alg2-file-list (directory (make-pathname :directory (pathname-directory alg2-dir)                                                   :name :wild                                                   :type "cbl")))         (part1-filenames          (mapcar #'(lambda (mc)                      (mapcar #'(lambda (mvt)                                  (first (member (first mvt)                                                 alg1-file-list                                                 :test #'string=                                                 :key #'(lambda (filename)                                                          (string-upcase (pathname-name filename))))))                              mc))                  partition))         (part2-filenames          (mapcar #'(lambda (mc)                      (mapcar #'(lambda (mvt)                                  (first (member (first mvt)                                                 alg2-file-list                                                 :test #'string=                                                 :key #'(lambda (filename)                                                          (string-upcase (pathname-name filename))))))                              mc))                  partition))         (part1-cbls (mapcar #'(lambda (mc)                                 (mapcar #'(lambda (filename)                                             (read-dataset filename))                                         mc))                             part1-filenames))         (part1-mc-cbls (mapcar #'(lambda (mc)                                    (apply #'append mc))                                 part1-cbls))         (part2-cbls (mapcar #'(lambda (mc)                                 (mapcar #'(lambda (filename)                                             (read-dataset filename))                                         mc))                             part2-filenames))         (part2-mc-cbls (mapcar #'(lambda (mc)                                    (apply #'append mc))                                 part2-cbls))         (nnotes-list-1 (mapcar #'list-length part1-mc-cbls))         (nnotes-list-2 (mapcar #'list-length part2-mc-cbls))         (dummy (if (not (equalp nnotes-list-1 nnotes-list-2))                  (progn (format t "~%ERROR: nnotes-list-1 not equal to nnotes-list-2")                         (abort))))         (alg1-mcner-list (mapcar #'(lambda (mc-cbl)                                      (/ (count 0 mc-cbl)                                         (list-length mc-cbl)))                                   part1-mc-cbls))         (alg2-mcner-list (mapcar #'(lambda (mc-cbl)                                      (/ (count 0 mc-cbl)                                         (list-length mc-cbl)))                                   part2-mc-cbls))         (diff-score-list (mapcar #'- alg2-mcner-list alg1-mcner-list ))         (mean-diff-score (mean diff-score-list))         (number-of-movement-classes (list-length partition))         (se-mean-diff-score (/ (standard-deviation diff-score-list) (sqrt number-of-movement-classes)))         (t-statistic (/ mean-diff-score se-mean-diff-score))         (alg1 (first (last (pathname-directory alg1-dir))))         (alg2 (first (last (pathname-directory alg2-dir))))         (number-of-movements (apply #'+ (mapcar #'list-length partition)))         (number-of-notes (apply #'+ nnotes-list-1))         (ner1 (/ (count 0 (apply #'append part1-mc-cbls))                  number-of-notes))         (ner2 (/ (count 0 (apply #'append part2-mc-cbls))                  number-of-notes))         (range (- (apply #'max diff-score-list)                   (apply #'min diff-score-list)))         (w-over-s (/ range (standard-deviation diff-score-list)))         (n-for-w-over-s (list-length diff-score-list))                  ;Wilcoxon's matched-pairs signed-ranks test         (sorted-list-of-diff-scores (sort diff-score-list                                           #'<                                           :key #'abs))         (set-of-abs-diff-scores (mapcar #'abs (remove-duplicates sorted-list-of-diff-scores                                                    :key #'abs)))         (diff-score-count-list (mapcar #'(lambda (d)                                            (count d sorted-list-of-diff-scores :key #'abs))                                        set-of-abs-diff-scores))         (diff-score-acc-count-list (let* ((acc-count-list nil)                                           (running-total 0))                                      (dolist (c diff-score-count-list (reverse acc-count-list))                                        (setf acc-count-list                                              (cons (+ c running-total)                                                    acc-count-list)                                              running-total (+ c running-total)))))         (rank-partition (do* ((rp))))         )    dummy    (format t "~%Algorithm 1: ~a" alg1)    (format t "~%Algorithm 2: ~a" alg2)    (format t "~%Number of movements = ~d" number-of-movements)    (format t "~%Number of movement classes = ~d" number-of-movement-classes)    (format t "~%Number of notes = ~d" number-of-notes)    (format t "~%Alg 1 movement class note error rates: ~a" (apply #'concatenate 'string                                                                   (mapcar #'(lambda (ner)                                                                               (format nil "~,5f " ner))                                                                           alg1-mcner-list)))    (format t "~%Alg 2 movement class note error rates: ~a" (apply #'concatenate 'string                                                                   (mapcar #'(lambda (ner)                                                                               (format nil "~,5f " ner))                                                                           alg2-mcner-list)))    (format t "~%Alg 1 mean movement class note error rate = ~,5f" (mean alg1-mcner-list))    (format t "~%Alg 2 mean movement class note error rate = ~,5f" (mean alg2-mcner-list))    (format t "~%Alg 1 overall note error rate = ~,5f" ner1)    (format t "~%Alg 2 overall note error rate = ~,5f" ner2)    (format t "~%Difference in overall note error rates = ~,5f" (- ner2 ner1))    (format t "~%Difference scores: ~a" (apply #'concatenate 'string                                               (mapcar #'(lambda (ds)                                                           (format nil "~,5f " ds))                                                       diff-score-list)))    (format t "~%Mean difference score = ~,5f" mean-diff-score)    (format t "~%SD of difference scores = ~,5f" (standard-deviation diff-score-list))    (format t "~%SE of mean differences scores = ~,5f" se-mean-diff-score)    (format t "~%matched-sample t-test: t = ~,5f, d.f. = ~d" t-statistic (1- number-of-movement-classes))    (format t "~%w/s normality test (Kanji, 1993, p.65): w/s = ~,3f, n = ~d" w-over-s n-for-w-over-s))  )|#;;;;;;;;;;;;;;;Generate R Input Data file(defun cbl-to-r (&optional (cbl-directory (choose-directory-dialog :button-string "CBL")))  (let* ((list-of-alg-dirs (directory (make-pathname :directory (pathname-directory cbl-directory)                                                                  :name :wild                                                                  )                                                   :directories t                                                   :files nil))         (list-of-algorithms (mapcar #'(lambda (alg-dir)                                         (first (last (pathname-directory alg-dir))))                                     list-of-alg-dirs))         (numbers-of-notes (mapcar #'list-length (mapcar #'read-dataset                                                          (directory (make-pathname :directory (pathname-directory (first list-of-alg-dirs))                                                                                   :name :wild                                                                                   :type "cbl")))))         (file-names (mapcar #'(lambda (file-name)                                (pathname-name file-name))                             (directory (make-pathname :directory (pathname-directory (first list-of-alg-dirs))                                                      :name :wild                                                      :type "cbl"))))         (composers (mapcar #'(lambda (file-name)                                (subseq file-name 0 4))                             file-names))         (note-error-counts (mapcar #'(lambda (alg-dir)                                        (mapcar #'(lambda (cbl)                                                    (count 0 cbl))                                                (mapcar #'read-dataset                                                         (directory (make-pathname :directory (pathname-directory alg-dir)                                                                                  :name :wild                                                                                  :type "cbl")))))                                    list-of-alg-dirs))         (movement-note-error-rates (mapcar #'(lambda (necs-for-this-alg)                                                (mapcar #'(lambda (nec nnotes)                                                            (* 1.0 (/ nec nnotes)))                                                        necs-for-this-alg                                                        numbers-of-notes))                                            note-error-counts))         (first-row (append (list "file.name" "comp" "nnotes" )                            (apply #'append (mapcar #'(lambda (alg)                                (list (concatenate 'string alg ".mnec")                                      (concatenate 'string alg ".mner")))                            list-of-algorithms))))         (other-rows (apply #'mapcar #'list                            (append (list file-names                                          composers                                          numbers-of-notes)                                    (apply #'append (mapcar #'(lambda (nec-list ner-list)                                                                (list nec-list ner-list))                                                            note-error-counts                                                            movement-note-error-rates)))))         (table (cons first-row other-rows)))    (mapcar #'(lambda (row)                (format t "~%")                (mapcar #'(lambda (item)                            (format t                                     (concatenate 'string "~a" (string #\Tab))                                    item))                        row))            table)    nil))#|(defun pitch-class-distribution (&optional (input-directory (choose-directory-dialog :button-string "OPND-M")))  (let* ((file-list (directory (make-pathname :directory (pathname-directory input-directory)                                              :name :wild                                              :type "opnd-m")))         (list-of-pitch-names (mapcar #'second                                      (apply #'append (mapcar #'(lambda (file-name)                                                                  (read-dataset file-name))                                                              file-list))))         (list-of-pitch-classes (mapcar #'(lambda (pn)                                            (mod (pn2midi pn) 12))                                        list-of-pitch-names))         (frequency-distribution (let* ((fd (list 0 0 0 0 0 0                                                  0 0 0 0 0 0)))                                   (dotimes (c 12 fd)                                     (setf (elt fd c)                                           (count c list-of-pitch-classes))))))))|#